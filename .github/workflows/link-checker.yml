name: Link Checker

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**.md'
  schedule:
    # Run weekly on Mondays at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-links:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check internal markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.github/workflows/link-checker-config.json'
          folder-path: 'docs/'
          file-path: './README.md, ./README.es.md, ./CONTRIBUTING.md, ./GLOSSARY.md'
      
      - name: Create issue if links are broken
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueTitle = 'üîó Broken Links Detected';
            const issueBody = `## Broken Links Found
            
            The automated link checker has detected broken links in the documentation.
            
            ### Action Required
            
            1. Check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details
            2. Fix broken internal links (relative paths)
            3. Update or remove broken external links
            4. Verify links in both English and Spanish versions
            
            ### Common Issues
            
            - **Moved files**: Update relative paths after reorganizing
            - **Renamed files**: Search and replace old filenames
            - **Deleted content**: Remove or redirect links
            - **External sites**: Check if URLs changed or sites went down
            
            ### Files to Check
            
            - README.md / README.es.md
            - docs/en/*.md
            - docs/es/*.md
            - CONTRIBUTING.md
            - GLOSSARY.md
            
            ---
            
            **Triggered by**: ${{ github.event_name }}
            **Run**: [#${context.runId}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links'
            });
            
            const existingIssue = issues.data.find(issue => issue.title === issueTitle);
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['broken-links', 'documentation', 'bug']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Broken links still detected. [Check latest run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              });
            }
      
      - name: Comment on PR if links broken
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ‚ùå Broken Links Detected
              
              This PR introduces or contains broken links. Please review the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.
              
              **Common fixes:**
              - Use relative paths for internal links (e.g., \`docs/en/MQTT-QUICK-GUIDE.md\`)
              - Verify file paths are correct after moving/renaming
              - Test external URLs are accessible
              - Check both language versions (EN/ES) have working links
              `
            });
