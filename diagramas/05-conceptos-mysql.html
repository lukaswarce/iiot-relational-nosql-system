<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conceptos MySQL - ACID y Relaciones</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
        }
        .mermaid {
            text-align: center;
            margin: 30px 0;
        }
        .concept-box {
            background: #e8f8f5;
            padding: 20px;
            border-left: 4px solid #27ae60;
            margin: 20px 0;
            border-radius: 5px;
        }
        .code-example {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì Conceptos Fundamentales - MySQL Relacional</h1>
        
        <h2>Mapa Mental: Conceptos ACID</h2>
        <div class="mermaid">
mindmap
  root((MySQL<br/>ACID))
    Atomicity
      Todo o Nada
      BEGIN TRANSACTION
      COMMIT completo
      ROLLBACK si error
      No estados parciales
    Consistency
      Datos v√°lidos
      Constraints activos
      Foreign Keys
      CHECK constraints
      Triggers validan
    Isolation
      Transacciones independientes
      Niveles de aislamiento
      READ COMMITTED
      REPEATABLE READ
      SERIALIZABLE
      Evita race conditions
    Durability
      Persistencia garantizada
      Despu√©s de COMMIT
      Sobrevive crashes
      Write-Ahead Log
      Recuperaci√≥n autom√°tica
        </div>
        
        <div class="concept-box">
            <h3>üîí Propiedad A - Atomicity (Atomicidad)</h3>
            <p><strong>Definici√≥n:</strong> Una transacci√≥n es una unidad at√≥mica - o se ejecuta completamente o no se ejecuta en absoluto.</p>
            
            <p><strong>Ejemplo del Mundo Real:</strong> Transferencia bancaria - si falla el dep√≥sito, el retiro tambi√©n debe deshacerse.</p>
            
            <div class="code-example">
<strong>-- Ejemplo de Transacci√≥n At√≥mica:</strong>

START TRANSACTION;

-- Paso 1: Registrar nuevo lote
INSERT INTO production_batches 
(line_id, batch_code, target_quantity)
VALUES (1, 'BATCH_2026_100', 1000);

-- Paso 2: Registrar evento de inicio
INSERT INTO production_events 
(batch_id, event_type, event_description)
VALUES (LAST_INSERT_ID(), 'start', 'Batch iniciado');

-- Si TODO es exitoso:
COMMIT; -- ‚úÖ Ambos INSERT se confirman

-- Si HAY ERROR:
ROLLBACK; -- ‚ùå Ambos INSERT se deshacen</div>
        </div>
        
        <div class="concept-box">
            <h3>‚úÖ Propiedad C - Consistency (Consistencia)</h3>
            <p><strong>Definici√≥n:</strong> La base de datos siempre pasa de un estado v√°lido a otro estado v√°lido.</p>
            
            <p><strong>Ejemplo:</strong> Los constraints garantizan que nunca haya datos inv√°lidos.</p>
            
            <div class="code-example">
<strong>-- Constraints que mantienen consistencia:</strong>

-- ‚ùå Esto FALLAR√Å (cantidad negativa):
INSERT INTO production_batches 
(line_id, batch_code, target_quantity, actual_quantity)
VALUES (1, 'BATCH_TEST', 1000, -50);
-- Error: chk_actual_quantity violated

-- ‚ùå Esto FALLAR√Å (l√≠nea no existe):
INSERT INTO production_batches 
(line_id, batch_code, target_quantity)
VALUES (999, 'BATCH_TEST', 1000);
-- Error: foreign key constraint fails

-- ‚úÖ Esto FUNCIONA (datos v√°lidos):
INSERT INTO production_batches 
(line_id, batch_code, target_quantity)
VALUES (1, 'BATCH_TEST', 1000);</div>
        </div>
        
        <h2>Mapa Mental: Integridad Referencial</h2>
        <div class="mermaid">
mindmap
  root((Integridad<br/>Referencial))
    Primary Keys
      Identificador √∫nico
      NOT NULL
      UNIQUE
      AUTO_INCREMENT
      Una columna o combinaci√≥n
    Foreign Keys
      Referencia a otra tabla
      Previene datos hu√©rfanos
      ON DELETE opciones
      ON UPDATE opciones
      Valida al INSERT/UPDATE
    ON DELETE CASCADE
      Borrar padre borra hijos
      √ötil para logs/eventos
      Autom√°tico y seguro
      Ejemplo: batch ‚Üí events
    ON DELETE RESTRICT
      No permite borrar padre
      Protege datos cr√≠ticos
      Fuerza limpieza manual
      Ejemplo: line ‚Üí batches
    CHECK Constraints
      Validaci√≥n de valores
      Rango de valores
      L√≥gica de negocio
      Ejecuta en INSERT/UPDATE
    UNIQUE Constraints
      Valor √∫nico en columna
      Diferente a PRIMARY KEY
      Puede tener NULLs
      Ejemplo: batch_code
        </div>
        
        <div class="concept-box">
            <h3>üîó Foreign Keys con CASCADE</h3>
            <p><strong>Caso de Uso:</strong> Borrar un batch autom√°ticamente borra sus eventos relacionados.</p>
            
            <div class="code-example">
<strong>-- Definici√≥n con CASCADE:</strong>

CREATE TABLE production_events (
    event_id INT PRIMARY KEY,
    batch_id INT NOT NULL,
    event_type ENUM('start', 'stop', 'pause'),
    
    <span style="color: #f39c12;">CONSTRAINT fk_event_batch 
    FOREIGN KEY (batch_id) 
    REFERENCES production_batches(batch_id)
    ON DELETE CASCADE  -- ‚ö†Ô∏è Borrar batch borra eventos
    ON UPDATE CASCADE  -- ‚úÖ Actualizar ID actualiza eventos</span>
);

<strong>-- Efecto:</strong>
DELETE FROM production_batches WHERE batch_id = 5;
-- ‚úÖ Autom√°ticamente borra todos los eventos del batch 5</div>
        </div>
        
        <div class="concept-box">
            <h3>üõ°Ô∏è Foreign Keys con RESTRICT</h3>
            <p><strong>Caso de Uso:</strong> Proteger l√≠neas de producci√≥n - no se pueden borrar si tienen batches activos.</p>
            
            <div class="code-example">
<strong>-- Definici√≥n con RESTRICT:</strong>

CREATE TABLE production_batches (
    batch_id INT PRIMARY KEY,
    line_id INT NOT NULL,
    
    <span style="color: #e74c3c;">CONSTRAINT fk_batch_line 
    FOREIGN KEY (line_id) 
    REFERENCES production_lines(line_id)
    ON DELETE RESTRICT  -- ‚ùå No permite borrar l√≠nea con batches
    ON UPDATE CASCADE   -- ‚úÖ Permite actualizar ID</span>
);

<strong>-- Efecto:</strong>
DELETE FROM production_lines WHERE line_id = 1;
-- ‚ùå Error: Cannot delete - referenced by batches
-- Debes borrar primero todos los batches de esa l√≠nea</div>
        </div>
        
        <h2>üéØ Flujo de Transacci√≥n ACID Completa</h2>
        <div class="mermaid">
sequenceDiagram
    participant App as üì± Aplicaci√≥n
    participant DB as üíæ MySQL
    participant Log as üìù WAL (Write-Ahead Log)
    
    App->>DB: BEGIN TRANSACTION
    Note over DB: Estado: INICIADA
    
    App->>DB: INSERT INTO production_batches
    DB->>DB: Validar constraints
    DB->>Log: Escribir en WAL
    Note over DB: A√∫n no permanente
    
    App->>DB: INSERT INTO production_events
    DB->>DB: Validar FK exists
    DB->>Log: Escribir en WAL
    Note over DB: A√∫n en memoria
    
    App->>DB: UPDATE production_lines
    DB->>DB: Validar datos
    DB->>Log: Escribir en WAL
    
    alt Todo OK
        App->>DB: COMMIT
        DB->>DB: ‚úÖ Hacer cambios permanentes
        DB->>Log: Marcar como committed
        DB-->>App: SUCCESS
        Note over DB: Durability garantizada
    else Error encontrado
        App->>DB: ROLLBACK
        DB->>DB: ‚ùå Deshacer todos los cambios
        DB->>Log: Marcar como rolled back
        DB-->>App: ROLLED BACK
        Note over DB: Vuelve a estado anterior
    end
        </div>
        
        <div class="concept-box">
            <h3>üí° Ejemplo Completo: Stored Procedure con ACID</h3>
            <div class="code-example">
DELIMITER $$

CREATE PROCEDURE crear_batch_seguro(
    IN p_line_id INT,
    IN p_batch_code VARCHAR(50),
    IN p_target_quantity INT,
    OUT p_resultado VARCHAR(100)
)
BEGIN
    -- ‚ùó Handler: Si hay error, hacer ROLLBACK autom√°tico
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET p_resultado = 'ERROR: Transacci√≥n revertida';
    END;
    
    -- üîí Iniciar transacci√≥n ACID
    START TRANSACTION;
    
    -- ‚úÖ Validaci√≥n 1: L√≠nea existe y est√° activa
    IF NOT EXISTS (
        SELECT 1 FROM production_lines 
        WHERE line_id = p_line_id AND status = 'active'
    ) THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'L√≠nea no existe o no est√° activa';
    END IF;
    
    -- ‚úÖ Validaci√≥n 2: C√≥digo de batch √∫nico
    IF EXISTS (
        SELECT 1 FROM production_batches 
        WHERE batch_code = p_batch_code
    ) THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'C√≥digo de batch duplicado';
    END IF;
    
    -- ‚úèÔ∏è Paso 1: Insertar batch
    INSERT INTO production_batches (
        line_id, batch_code, target_quantity, status
    ) VALUES (
        p_line_id, p_batch_code, p_target_quantity, 'in_progress'
    );
    
    -- ‚úèÔ∏è Paso 2: Registrar evento de inicio
    INSERT INTO production_events (
        batch_id, event_type, event_description
    ) VALUES (
        LAST_INSERT_ID(), 
        'start', 
        CONCAT('Batch ', p_batch_code, ' iniciado')
    );
    
    -- üíæ Si todo OK, confirmar cambios permanentemente
    COMMIT;
    SET p_resultado = CONCAT('‚úÖ Batch ', p_batch_code, ' creado');
END$$

DELIMITER ;</div>
        </div>
        
        <h2>üìä Normalizaci√≥n vs Desnormalizaci√≥n</h2>
        <div class="mermaid">
graph TB
    subgraph "‚ùå Datos NO Normalizados - Redundancia"
        T1["Tabla: orders<br/>--------------<br/>order_id | customer_name | customer_email | customer_phone | product_name | product_price<br/>1 | Juan P√©rez | juan@email.com | 555-1234 | Sensor A | $100<br/>2 | Juan P√©rez | juan@email.com | 555-1234 | Sensor B | $200<br/>‚ö†Ô∏è Nombre/email/tel√©fono REPETIDOS"]
    end
    
    subgraph "‚úÖ Datos Normalizados - Sin Redundancia"
        T2["Tabla: customers<br/>--------------<br/>customer_id | name | email | phone<br/>1 | Juan P√©rez | juan@email.com | 555-1234"]
        T3["Tabla: products<br/>--------------<br/>product_id | name | price<br/>101 | Sensor A | $100<br/>102 | Sensor B | $200"]
        T4["Tabla: orders<br/>--------------<br/>order_id | customer_id | product_id<br/>1 | 1 | 101<br/>2 | 1 | 102"]
        
        T4 -->|FK| T2
        T4 -->|FK| T3
    end
    
    style T1 fill:#ffcccc
    style T2 fill:#ccffcc
    style T3 fill:#ccffcc
    style T4 fill:#ccffcc
        </div>
        
        <div class="concept-box">
            <h3>üéØ Beneficios de MySQL en IIoT</h3>
            <ul>
                <li><strong>‚úÖ Integridad de Datos</strong> - Constraints previenen datos inv√°lidos</li>
                <li><strong>‚úÖ Transacciones Seguras</strong> - ACID garantiza consistencia</li>
                <li><strong>‚úÖ Relaciones Complejas</strong> - JOINs permiten consultas sofisticadas</li>
                <li><strong>‚úÖ Reportes Avanzados</strong> - Agregaciones multi-tabla</li>
                <li><strong>‚úÖ Auditor√≠a y Trazabilidad</strong> - Foreign Keys mantienen historial</li>
                <li><strong>‚úÖ Madurez y Soporte</strong> - Tecnolog√≠a probada por d√©cadas</li>
            </ul>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>
